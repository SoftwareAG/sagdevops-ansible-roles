---

- name: Print the params
  debug:
    msg: "Running apiportal with command {{ webmethods_apiportal_acc_command | default('undefined') }}"
    verbosity: 1

- name: fail if webmethods_apiportal_acc_command not specified
  fail: 
    msg: "webmethods_apiportal_acc_command not specified...cannot do anything."
  when: webmethods_apiportal_acc_command is not defined or webmethods_apiportal_acc_command == ""

- name: fail if mandatory param not specified
  fail: 
    msg: "A mandatory param was not defined, cannot do anything."
  when: item is not defined
  with_items:
    - "{{ webmethods_apiportal_acc_host }}"
    - "{{ webmethods_apiportal_acc_port }}"
    - "{{ webmethods_apiportal_acc_user }}"
    - "{{ webmethods_apiportal_acc_password }}"

- name: execute command
  command:
    argv:
      - "acc.sh"
      - "-h"
      - "{{webmethods_apiportal_acc_host}}"
      - "-u"
      - "{{webmethods_apiportal_acc_user}}"
      - "-pwd"
      - "{{webmethods_apiportal_acc_password}}"
      - "-p"
      - "{{webmethods_apiportal_acc_port}}"
      - "{{webmethods_apiportal_acc_command}}"
    chdir: "{{ webmethods_apiportal_acc_exec_dir }}"
  async: 1800
  poll: 0
  register: cmd_async
  no_log: "{{ not ( disable_no_log | default(false,true) ) }}"

- name: "Check status for command"
  async_status:
    jid: "{{ cmd_async.ansible_job_id }}"
  register: cmd_result
  until: cmd_result.finished
  retries: 360
  delay: 5

- name: Print the cmd_result to the console.
  debug:
    msg: "{{ cmd_result.stdout_lines | join('\n') }}"
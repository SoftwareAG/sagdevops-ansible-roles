---


- name: fail if webmethods_localrepo_target_dir not specified
  fail: 
    msg: "webmethods_localrepo_target_dir not specified...can't do anything"
  when: webmethods_localrepo_target_dir is not defined or webmethods_localrepo_target_dir == ""

- name: Create local dir folder for artifacts
  file: 
    path: "{{ webmethods_localrepo_target_dir }}"
    state: directory
    owner: "{{ webmethods_localrepo_target_dir_owner_user }}"
    group: "{{ webmethods_localrepo_target_dir_owner_group }}"
    mode: 0755

- name: Write the various scripts with all the params in them
  template:
    src: "{{ item.src }}" 
    dest: "{{ item.dest }}"
    backup: no
    owner: "{{ webmethods_localrepo_target_dir_owner_user }}"
    group: "{{ webmethods_localrepo_target_dir_owner_group }}"
    mode: 0644
  with_items:
    - { src: 'get_artifacts_from_s3.sh.j2', dest: '{{ webmethods_localrepo_target_dir }}/get_artifacts_from_s3.sh' }

- name: run get_artifacts_from_s3 command
  command: get_artifacts_from_s3.sh
  args:
    chdir: "{{ webmethods_localrepo_target_dir }}"
  async: 1000
  poll: 0
  register: get_artifacts_from_s3_sleeper

- name: Check status for artifacts download
  async_status:
    jid: "{{ get_artifacts_from_s3_sleeper.ansible_job_id }}"
  register: job_result
  until: job_result.finished
  retries: 100
  delay: 10

- name: Print the job_result to the console.
  debug:
    msg: "{{ job_result.stdout_lines | join('\n') }}"
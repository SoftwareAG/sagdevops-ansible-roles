#!/bin/sh

echo "Begin $0"
 
THIS=`basename $0`
THISDIR=`dirname $0`; THISDIR=`cd $THISDIR;pwd`
THIS_HOSTNAME=`hostname --long`

echo "Current hostname: $THIS_HOSTNAME"
echo "Current folder: $THISDIR"
ls -al $THISDIR

## load utils functions
function replace_global { 
    local pattern=$1;
    local replacement=$2;
    local file=$3;
    sed -i 's#'"$pattern"'#'"$replacement"'#g' $file
}

## set params to default if not defined already (ie. env variables)
if [ "x$__work_dir" == "x" ]; then
    __work_dir="{{ webmethods_localrepo_target_dir | default('/opt/softwareag/sag_install_artifacts', true) }}"
fi

if [ "x$__installer_target_path" == "x" ]; then
    __installer_target_path="{{ webmethods_install_target_dir | default('/opt/softwareag', true) }}"
fi

if [ "x$__installer_executable" == "x" ]; then
    __installer_executable="{{ webmethods_localrepo_installer_filename | default('softwareaginstaller-linux.bin', true) }}"
fi

if [ "x$__installer_script" == "x" ]; then
    __installer_script="{{ webmethods_localrepo_products_autoscript_filename | default('installer.script', true) }}"
fi

if [ "x$__installer_product_image" == "x" ]; then
    __installer_product_image="{{ webmethods_localrepo_products_image_filename | default('installer_image.zip', true) }}"
fi

if [ "x$__installer_product_license" == "x" ]; then
    __installer_product_license="{{ webmethods_localrepo_license_filepath | default('installer_license.xml', true) }}"
fi

{% raw %}

## replace values in the webMethods Installer script
replace_global "{{ __installer_target_path }}" "${__installer_target_path}" "$__installer_script"
replace_global "{{ __installer_product_license }}" "${__work_dir}/${__installer_product_license}" "$__installer_script"
replace_global "{{ __installer_product_image }}" "${__work_dir}/${__installer_product_image}" "$__installer_script"
replace_global "{{ __installer_target_hostname }}" "$THIS_HOSTNAME" "$__installer_script"

echo "Before install - target install dir: $__installer_target_path"
ls -al $__installer_target_path

## run installer
/bin/sh ${__installer_executable} -scriptErrorInteract no -readScript ${__work_dir}/${__installer_script}

echo "After install - target install dir: $__installer_target_path"
ls -al $__installer_target_path

echo DONE!!

{% endraw %}
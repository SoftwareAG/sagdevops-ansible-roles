---

- name: fail if webmethods_localrepo_target_dir not specified
  fail: 
    msg: "webmethods_localrepo_target_dir not specified...can't do anything"
  when: webmethods_localrepo_target_dir is not defined or webmethods_localrepo_target_dir == ""

- name: Create local dir folder for artifacts
  file: 
    path: "{{ webmethods_localrepo_target_dir }}"
    state: directory
    owner: "{{ webmethods_localrepo_target_dir_owner_user }}"
    group: "{{ webmethods_localrepo_target_dir_owner_group }}"
    mode: 0755

- name: Copy resource files to target
  copy:
    src: "{{ item }}"
    dest: "{{ webmethods_localrepo_target_dir }}"
    owner: "{{ webmethods_localrepo_target_dir_owner_user }}"
    group: "{{ webmethods_localrepo_target_dir_owner_group }}"
    mode: 0644
    remote_src: no
  with_fileglob:
    - "./resources/download_helper.sh"

- name: Write the various scripts with all the params in them
  template:
    src: "{{ item.src }}" 
    dest: "{{ item.dest }}"
    backup: no
    owner: "{{ webmethods_localrepo_target_dir_owner_user }}"
    group: "{{ webmethods_localrepo_target_dir_owner_group }}"
    mode: 0644
  with_items:
    - { src: 'get_artifacts_from_s3.sh.j2', dest: '{{ webmethods_localrepo_target_dir }}/get_artifacts_from_s3.sh' }
    - { src: 'install_product.sh.j2', dest: '{{ webmethods_localrepo_target_dir }}/install_product.sh' }
    - { src: 'install_fixes.sh.j2', dest: '{{ webmethods_localrepo_target_dir }}/install_fixes.sh' }
    - { src: 'install_sum.sh.j2', dest: '{{ webmethods_localrepo_target_dir }}/install_sum.sh' }
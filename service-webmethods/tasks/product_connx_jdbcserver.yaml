---

  - name: Set systemd service for CONNX JDBC Server
    block:

      - name: Copy systemd script files
        copy:
          src: "{{ item }}"
          dest: "{{ webmethods_install_dir }}/connx"
          owner: "{{ webmethods_user }}"
          group: "{{ webmethods_group }}"
          mode: 0755
          remote_src: no
        with_items:
          - "resources/cnxJDBCsrv_sys.sh"

      - include_tasks: "command_createcustom.yaml"
        vars:
          service_name: "sag1cnxJDBCsrv{{ product_version_full }}"
          full_unit_env:
            Description: "SoftwareAG CONNX JDBC Server"
            After: "multi-user.target network-online.target"
            Requires: "network-online.target"
          full_service_env:
            Type: "simple"
            User: "{{ service_user }}"
            Group: "{{ service_user }}"
            WorkingDirectory: "{{ webmethods_install_dir }}/connx"
            ExecStart: "{{ webmethods_install_dir }}/connx/jdbcserver START"
            ExecStop: "{{ webmethods_install_dir }}/connx/jdbcserver STOP"
            PrivateTmp: "no"
            KillMode: "none"
            TimeoutStartSec: 330
            TimeoutStopSec: 330
            RemainAfterExit: "no"
            Restart: "on-failure"
            RestartSec: 90
          full_install_env:
            WantedBy: multi-user.target

      - name: create systemd override directory
        file:
          path: /etc/systemd/system/{{ service_name }}.service.d
          state: directory

      - name: delete override file first if it exists (for compatibility with older concept)
        file:
          path: /etc/systemd/system/{{ service_name }}.service.d/connx_envs.conf
          state: absent

      - name: touch to mark that it's been run
        file:
          path: /etc/systemd/system/{{ service_name }}.service.d/connx_envs.conf
          state: touch

      - name: Write params to file
        blockinfile:
          path: /etc/systemd/system/{{ service_name }}.service.d/connx_envs.conf
          create: yes
          block: |
            [Service]
            Environment="CONNXREGISTRY={{ webmethods_install_dir }}/connx/connxreg.db"
            Environment="CONNXREGISTRY64={{ webmethods_install_dir }}/connx/connxreg64.db"
      
      - name: force systemd to reread configs after modification
        systemd: daemon_reload=yes

    when: product_command == "create"

  - include_tasks: "command_{{ product_command }}.yaml"
    vars:
      service_name: "sag1cnxJDBCsrv{{ product_version_full }}"
    when: product_command != "create"
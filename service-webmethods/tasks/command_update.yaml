---

### Needs:
### - service_name
### - service_env

  - name: fail if service_name not specified
    fail: 
      msg: "service_name not specified...cannot create."
    when: service_name is not defined or service_name == ""

  - name: get service facts
    service_facts:

  - name: Format service name to {{ service_name }}.service for service_facts lookup
    set_fact:
      service_name_index: "{{ service_name }}.service"

  - name: fail if service is not found
    fail: 
      msg: "service {{ service_name }} not found..."
    when: ansible_facts.services[service_name_index] is not defined

  - name: Perform service overrides if service exists
    block:
      - name: create systemd override directory
        file:
          path: /etc/systemd/system/{{ service_name }}.service.d
          state: directory

      - name: delete override file first if it exists
        file:
          path: /etc/systemd/system/{{ service_name }}.service.d/override.conf
          state: absent

      - name: create override file
        file:
          path: /etc/systemd/system/{{ service_name }}.service.d/override.conf
          state: touch

      - name: Populate systemd override if the service_env are defined
        template:
          src: override.j2
          dest: /etc/systemd/system/{{ service_name }}.service.d/override.conf
        when: service_env is defined and service_env.keys()|length > 0

      - name: force systemd to reread configs after modification
        systemd: daemon_reload=yes
        
    when: ansible_facts.services[service_name_index] is defined and ansible_facts.services[service_name_index].source == "systemd"
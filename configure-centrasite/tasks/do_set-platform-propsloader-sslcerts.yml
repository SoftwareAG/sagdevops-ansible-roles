---

  - name: Set changed flag to false if not defined
    set_fact: 
      configure_centrasite_set_platform_propsloader_sslcerts: false
    when: configure_centrasite_set_platform_propsloader_sslcerts is not defined

  - name: Set variable defaults
    set_fact: 
      rvar_centrasite_props_https_keystore_path: ""
    when: rvar_centrasite_props_https_keystore_path is not defined
    
  - name: Set variable defaults
    set_fact: 
      rvar_centrasite_props_https_keystore_password: ""
    when: rvar_centrasite_props_https_keystore_password is not defined
  
  - name: Set variable defaults
    set_fact: 
      rvar_centrasite_props_https_keystore_type: ""
    when: rvar_centrasite_props_https_keystore_type is not defined
    
  - name: Set variable defaults
    set_fact: 
      rvar_centrasite_props_https_truststore_path: ""
    when: rvar_centrasite_props_https_truststore_path is not defined
  
  - name: Set variable defaults
    set_fact: 
      rvar_centrasite_props_https_truststore_password: ""
    when: rvar_centrasite_props_https_truststore_password is not defined

  - name: Set variable defaults
    set_fact: 
      rvar_centrasite_props_https_truststore_type: ""
    when: rvar_centrasite_props_https_truststore_type is not defined
    
  - name: Set force_change flag to false if not defined
    set_fact: 
      rvar_centrasite_props_https_force_change: false
    when: rvar_centrasite_props_https_force_change is not defined

  - name: check if marker file already there
    stat: 
      path: "{{ configure_centrasite_params_platform_propsloader_dir }}/.ansible_marker"
    register: previous_run_marker

  - name: Generate new marker based on current passed in values, and write it to a test file
    blockinfile:
      path: "{{ configure_centrasite_params_platform_propsloader_dir }}/.ansible_marker_test"
      create: yes
      backup: no
      mode: 0600
      block: |
        {{ rvar_centrasite_props_https_keystore_path | password_hash('sha512', 65534 | random(seed=inventory_hostname) | string) }}
        {{ rvar_centrasite_props_https_keystore_password | password_hash('sha512', 65534 | random(seed=inventory_hostname) | string) }}
        {{ rvar_centrasite_props_https_keystore_type | password_hash('sha512', 65534 | random(seed=inventory_hostname) | string) }}
        {{ rvar_centrasite_props_https_truststore_path | password_hash('sha512', 65534 | random(seed=inventory_hostname) | string) }}
        {{ rvar_centrasite_props_https_truststore_password | password_hash('sha512', 65534 | random(seed=inventory_hostname) | string) }}
        {{ rvar_centrasite_props_https_truststore_type | password_hash('sha512', 65534 | random(seed=inventory_hostname) | string) }}
    no_log: "{{ not ( disable_no_log | default(false,true) ) }}"

  - name: Get md5 from the new test file
    stat:
      path: "{{ configure_centrasite_params_platform_propsloader_dir }}/.ansible_marker_test"
    register: new_run_marker

  - name: set change action to true if the old marker file is not there (ie. first time) or the marker files do not match
    set_fact:
      rvar_centrasite_props_https_force_change: "{{ previous_run_marker.stat.exists == false or new_run_marker.stat.checksum != previous_run_marker.stat.checksum }}"
    when: rvar_centrasite_props_https_force_change | default() | bool == false

  - name: Print the force_change var
    debug:
      var: rvar_centrasite_props_https_force_change
      verbosity: 1

  - name: Set new ssl settings
    block:

      - name: Find the https file
        find:
          paths: "{{ configure_centrasite_params_platform_propsloader_dir }}"
          file_type: file
          use_regex: no
          recurse: no
          patterns: ['com.softwareag.catalina.connector.https.*.properties']
        register: platform_propsloader_https_file

      - name: fail if file not there
        fail: 
          msg: "File {{ configure_centrasite_params_platform_propsloader_dir }}/com.softwareag.catalina.connector.https.*.properties could not be found..."
        when: platform_propsloader_https_file.matched == 0

      - name: "Update config file with custom SSL certs"
        lineinfile:
          path: "{{ platform_propsloader_https_file.files[0].path }}"
          regexp: '^{{ item.key }}'
          insertafter: '^#{{ item.key }}'
          line: "{{ item.key }}={{ item.value }}"
        no_log: "{{ not ( disable_no_log | default(false,true) ) }}"
        when: item.value is defined and item.value != ""
        register: "result_set_ssl"
        with_dict:
          "keystoreFile": "{{ rvar_centrasite_props_https_keystore_path }}"
          "@secure.keystorePass": "{{ rvar_centrasite_props_https_keystore_password }}"
          "keystoreType": "{{ rvar_centrasite_props_https_keystore_type }}"
          "truststoreFile": "{{ rvar_centrasite_props_https_truststore_path }}"
          "@secure.truststorePass": "{{ rvar_centrasite_props_https_truststore_password }}"
          "truststoreType": "{{ rvar_centrasite_props_https_truststore_type }}"

      - name: Generate changed marker and write it to file
        blockinfile:
          path: "{{ configure_centrasite_params_platform_propsloader_dir }}/.ansible_marker"
          create: yes
          backup: no
          mode: 0600
          block: |
            {{ rvar_centrasite_props_https_keystore_path | password_hash('sha512', 65534 | random(seed=inventory_hostname) | string) }}
            {{ rvar_centrasite_props_https_keystore_password | password_hash('sha512', 65534 | random(seed=inventory_hostname) | string) }}
            {{ rvar_centrasite_props_https_keystore_type | password_hash('sha512', 65534 | random(seed=inventory_hostname) | string) }}
            {{ rvar_centrasite_props_https_truststore_path | password_hash('sha512', 65534 | random(seed=inventory_hostname) | string) }}
            {{ rvar_centrasite_props_https_truststore_password | password_hash('sha512', 65534 | random(seed=inventory_hostname) | string) }}
            {{ rvar_centrasite_props_https_truststore_type | password_hash('sha512', 65534 | random(seed=inventory_hostname) | string) }}
        no_log: "{{ not ( disable_no_log | default(false,true) ) }}"

      - name: Pause for 5 seconds to give a bit of time for the password encryptions to happen
        pause:
          seconds: "5"

      - name: Set changed flag to true
        set_fact: 
          configure_centrasite_set_platform_propsloader_sslcerts: true

    when: rvar_centrasite_props_https_force_change | bool

  - name: Print the changed var
    debug:
      var: configure_centrasite_set_platform_propsloader_sslcerts
      verbosity: 1
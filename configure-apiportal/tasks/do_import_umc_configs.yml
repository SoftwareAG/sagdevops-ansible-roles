---

  - debug: var=webmethods_apiportal_tenantmgmt_server verbosity=3
  - debug: var=webmethods_apiportal_tenantmgmt_tenant verbosity=3
  - debug: var=webmethods_apiportal_tenantmgmt_runas_username verbosity=3
  - debug: var=webmethods_apiportal_tenantmgmt_runas_password verbosity=3
    no_log: "{{ not ( disable_no_log | default(false,true) ) }}"
  - debug: var=webmethods_apiportal_tenantmgmt_importconfigfile_filepath verbosity=3

  - name: fail if mandatory param not specified
    fail: 
      msg: "A mandatory param was not defined, cannot do anything."
    when: item is not defined
    with_items:
      - "{{ webmethods_apiportal_tenantmgmt_server }}"
      - "{{ webmethods_apiportal_tenantmgmt_tenant }}"
      - "{{ webmethods_apiportal_tenantmgmt_runas_username }}"
      - "{{ webmethods_apiportal_tenantmgmt_importconfigfile_filepath }}"

  - name: Init the command
    set_fact:
      command_to_exec: ['./y-tenantmgmt.sh']

  - name: append server connection uri
    set_fact:
      command_to_exec: "{{ command_to_exec }} + [ '--server' ] + [ '{{ webmethods_apiportal_tenantmgmt_server }}' ]"

  - name: append tenant name
    set_fact:
      command_to_exec: "{{ command_to_exec }} + [ '--tenant' ] + [ '{{ webmethods_apiportal_tenantmgmt_tenant }}' ]"

  - name: append command name
    set_fact:
      command_to_exec: "{{ command_to_exec }} + [ 'importConfigFile' ]"

  - name: append admin user
    set_fact:
      command_to_exec: "{{ command_to_exec }} + [ '-u' ] + [ '{{ webmethods_apiportal_tenantmgmt_runas_username }}' ]"

  - name: append admin user password
    set_fact:
      command_to_exec: "{{ command_to_exec }} + [ '-p' ] + [ '{{ webmethods_apiportal_tenantmgmt_runas_password }}' ]"
    no_log: "{{ not ( disable_no_log | default(false,true) ) }}"

  - name: append config file to import
    set_fact:
      command_to_exec: "{{ command_to_exec }} + [ '-f' ] + [ '{{ webmethods_apiportal_tenantmgmt_importconfigfile_filepath }}' ]"

  - name: Print the command that we're going to run
    debug:
      msg: "About to run: {{ command_to_exec|join(' ') }}"
    no_log: "{{ not ( disable_no_log | default(false,true) ) }}"

  - name: execute command
    command:
      argv: "{{ command_to_exec }}"
      chdir: "{{ webmethods_apiportal_tools_dir }}"
    register: cmd_result
    no_log: "{{ not ( disable_no_log | default(false,true) ) }}"

  - name: Print the cmd_result to the console.
    debug:
      msg: "{{ cmd_result.stdout_lines | join('\n') }}"
---

  - name: set initial facts
    set_fact:
      runnable_suffix: ""

  - name: Set runnable suffix
    set_fact:
      runnable_suffix: "l"
    when: webmethods_apiportal_acc_install_size is defined and webmethods_apiportal_acc_install_size == "large"

  - name: Set runnable suffix
    set_fact:
      runnable_suffix: "m"
    when: webmethods_apiportal_acc_install_size is defined and webmethods_apiportal_acc_install_size == "medium"

  - name: Set runnable suffix
    set_fact:
      runnable_suffix: "s"
    when: webmethods_apiportal_acc_install_size is defined and webmethods_apiportal_acc_install_size == "small"

  - name: Command apply ssl certs
    block:

      - name: fail if runnable_suffix not specified
        fail: 
          msg: "runnable_suffix not specified...cannot do anything."
        when: runnable_suffix is not defined or runnable_suffix == ""

      - name: installing needed package to convert the JKS into the expected format 
        import_role: 
          name: manage-packages
        vars:
          extra_packages: []
          mandatory_packages:
            - openssl
            - zip

      - name: Check the source key store to make sure it all works
        import_role: 
          name: java-certs
        vars:
          command: list-keystore
          java_home: "{{ webmethods_apiportal_java_home }}"
          java_keystore_path: "{{ webmethods_keystore_local_path }}"
          java_keystore_password: "{{ webmethods_secrets_keystore_password }}"
  
      - name: convert from the JKS keystore to the CRT/KEY files that HTTPD expects for SSL
        import_role: 
          name: java-certs
        vars:
          command: convert-jks-to-httpd-certs
          java_home: "{{ webmethods_apiportal_java_home }}"
          jks_input_file_path: "{{ webmethods_keystore_local_path }}"
          jks_input_file_password: "{{ webmethods_secrets_keystore_password }}"
          jks_input_file_alias: "{{ webmethods_keystore_keyalias }}"
          httpd_certs_output_dir: "/opt/softwareag/certs"
          httpd_certs_output_crt_file: "server.crt"
          httpd_certs_output_key_file: "server.key"
      
      - name: Create a zip archive of the newly created CRT/KEY files
        archive:
          path:
            - /opt/softwareag/certs/server.crt
            - /opt/softwareag/certs/server.key
          dest: /opt/softwareag/certs/apiportal_ssl_certs.zip
          format: zip
        register: apiportal_ssl_certs

      - import_role: 
          name: command-apiportal
        vars:
          webmethods_apiportal_acc_command: "stop loadbalancer_{{ runnable_suffix }}"

      - import_role: 
          name: command-apiportal
        vars:
          webmethods_apiportal_acc_command: "enhance loadbalancer_{{ runnable_suffix }} with sslCertificate local file {{ apiportal_ssl_certs.dest }}"

      - import_role: 
          name: command-apiportal
        vars:
          webmethods_apiportal_acc_command: "start loadbalancer_{{ runnable_suffix }}"
    
    when: webmethods_apiportal_ssl_zip_path is defined and webmethods_apiportal_ssl_zip_path != ""
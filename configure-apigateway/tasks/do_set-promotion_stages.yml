---
## need to check if stage name exists...and create or update accordingly...
## TODO: Unable to create stage as name DEV already exists

  - name: API Gateway new promotion stages
    debug: var=webmethods_apigateway_promotions_stages

  - name: Get all current API Gateway promotion stages
    uri:
      url: "{{ apigateway_rest_promotionmgt_stages }}"
      method: GET
      user: "{{ apigateway_rest_login_username }}"
      password: "{{ apigateway_rest_login_password }}"
      return_content: yes
      force_basic_auth: yes
      validate_certs: false
      status_code: "200"
      body_format: json
      timeout: 30
    register: get_all_promotionmgt_stages

  - name: Response for All Current promotion stages
    debug: var=get_all_promotionmgt_stages

  - name: Parse response and extract id fields
    set_fact:
      promotionmgt_stage_ids: "{{ lookup('template', 'apigateway_restapi_get_promotion_stages_ids.json.j2') }}"

  - name: Parsed all current promotion stage ids
    debug: var=promotionmgt_stage_ids

  # - name: Delete all stages
  #   uri:
  #     url: "{{ apigateway_rest_configurations_apiportal_connect }}/{{ portalgateway_id }}"
  #     method: PUT
  #     user: "{{ apigateway_rest_login_username }}"
  #     password: "{{ apigateway_rest_login_password }}"
  #     return_content: yes
  #     body: "{{ webmethods_apigateway_portalgateway | default({}) | to_json }}"
  #     force_basic_auth: yes
  #     validate_certs: false
  #     status_code: "200"
  #     body_format: json
  #     timeout: 30
  #   no_log: yes
  #   register: mutate_update_portalgateway_response
  #   when: portalgateway_id is defined and portalgateway_id != ""



  # - name: Add promotion stages
  #   uri:
  #     url: "{{ apigateway_rest_promotionmgt_stages }}"
  #     method: POST
  #     user: "{{ apigateway_rest_login_username }}"
  #     password: "{{ apigateway_rest_login_password }}"
  #     return_content: yes
  #     body: "{{ item | to_json }}"
  #     force_basic_auth: yes
  #     validate_certs: false
  #     status_code: "200"
  #     body_format: json
  #     timeout: 30
  #   # no_log: yes
  #   register: mutate_promotions_stages
  #   with_items: "{{ webmethods_apigateway_promotions_stages }}"

  # - name: Response for new mutated Portal Gateway
  #   debug: var=mutate_promotions_stages
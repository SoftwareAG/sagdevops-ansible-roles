---

  - debug: var=apigateway_samlsso_autogenerated_metadata_url verbosity=1
  - debug: var=apigateway_samlsso_metadata_path verbosity=1
  - debug: var=apigateway_samlsso_metadata_location_uri verbosity=1

  - name: Get metadata
    include_role:
      name: curl-wrapper
    vars:
      command: download-file
      curl_wrapper_headers_fields:
        "Accept": "text/plain"
      curl_wrapper_no_check_certs: "{{ apigateway_rest_no_check_certs }}"
      curl_wrapper_target_uri: "{{ apigateway_samlsso_autogenerated_metadata_url }}"
      curl_wrapper_output_path: "{{ apigateway_samlsso_metadata_path }}"

  - name: check if curl download created the file
    stat: 
      path: "{{ apigateway_samlsso_metadata_path }}"
    register: curl_download

  - name: Execute following tasks only if file was downloaded
    block:

      - name: escape special regex chars in base uri  
        set_fact:
          regex_pattern: "{{ apigateway_base_uri | replace('/', '\\/') }}"

      - name: Update the file, replacing the host urls with specific params
        replace:
          path: "{{ apigateway_samlsso_metadata_path }}"
          backup: no
          regexp: "{{ regex_pattern }}"
          replace: "{{ apigateway_samlsso_metadata_location_uri }}"
    
    when: curl_download.stat.exists | bool

  - name: Print warning if SP Metdata was not downloaded
    debug:
      msg: "WARNING: SAML SP Metdata could not be downloaded from API gateway at {{ apigateway_samlsso_autogenerated_metadata_url }}"
      verbosity: 0
    when: not (curl_download.stat.exists | bool)

  - name: Set changed flag to true if any mutating operation did change (TODO)
    set_fact:
      configure_apigateway_update_saml_sp_metadata_changed: true
---

  - debug: var=apigateway_samlsso_autogenerated_metadata_url verbosity=3
  - debug: var=apigateway_samlsso_metadata_path verbosity=3
  - debug: var=apigateway_samlsso_metadata_location_uri verbosity=3

  - name: Get metadata
    include_role:
      name: curl-wrapper
    vars:
      command: download-file
      curl_wrapper_headers_fields:
        "Accept": "text/plain"
      curl_wrapper_target_uri: "{{ apigateway_samlsso_autogenerated_metadata_url }}"
      curl_wrapper_output_path: "{{ apigateway_samlsso_metadata_path }}"

  - name: escape special regex chars in base uri  
    set_fact:
      regex_pattern: "{{ apigateway_base_uri | replace('/', '\\/') }}"

  - name: Update the file, replacing the host urls with specific params
    replace:
      path: "{{ apigateway_samlsso_metadata_path }}"
      backup: no
      regexp: "{{ regex_pattern }}"
      replace: "{{ apigateway_samlsso_metadata_location_uri }}"